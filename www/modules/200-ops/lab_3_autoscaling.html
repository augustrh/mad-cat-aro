<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Modern App Dev Roadshow - Cloud Architect Track for ARO</title>
    <link rel="prev" href="lab_2_managing_worker_nodes.html">
    <link rel="next" href="lab_4_labeling_nodes.html">
    <meta name="generator" content="Antora 3.1.5">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="../..">Modern App Dev Roadshow - Cloud Architect Track for ARO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_1_environment.html">Explore the environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_2_access_cluster.html">Access your ARO cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_1_cluster_upgrades.html">Upgrade your ARO cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_2_managing_worker_nodes.html">Managing Worker Nodes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="lab_3_autoscaling.html">Autoscale your ARO Cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_4_labeling_nodes.html">Labeling your Worker Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_5_observability.html">Configure Red Hat OpenShift Logging with Azure Files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_1_deploy_app.html">Deploy an application with Azure Database</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_2_openshift_gitops.html">Deploy an application with Red Hat OpenShift GitOps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_3_network_policy.html">Secure your applications with Network Policies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_4_resilient_app.html">Make your application resilient</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_1_service_mesh_introduction.html">Service Mesh Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_2_service_mesh_deploy_operator.html">Install Service Mesh Operator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_3_service_mesh_deploy_control_plane.html">Deploy Service Mesh Control Plane</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_4_service_mesh_deploy_app.html">Deploy a Service Mesh example application</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_5_service_mesh_weighted_routing.html">Set up Service Mesh Weighted Routing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_6_service_mesh_observe.html">Configure and observe Service Mesh traffic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../conclusion.html">Conclusion &amp; What&#8217;s Next</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></li>
    <li><a href="lab_3_autoscaling.html">Autoscale your ARO Cluster</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/content/modules/ROOT/pages/200-ops/lab_3_autoscaling.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ARO Cluster Autoscaler is a feature that helps automatically adjust the size of an ARO cluster based on the current workload and resource demands. Cluster Autoscaler offers automatic and intelligent scaling of ARO clusters, leading to efficient resource utilization, improved application performance, high availability, and simplified cluster management. By dynamically adjusting the cluster size based on workload demands, it helps organizations optimize their infrastructure costs while ensuring optimal application performance and scalability. The cluster autoscaler does not increase the cluster resources beyond the limits that you specify.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/diagram-cluster-autoscaler.png" alt="Diagram illustrating the cluster autoscaler process">
</div>
</div>
<div class="paragraph">
<p>To learn more about cluster autoscaling, visit the <a href="https://docs.openshift.com/container-platform/latest/machine_management/applying-autoscaling.html" target="_blank" rel="noopener">Red Hat documentation for cluster autoscaling</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_machine_autoscaler"><a class="anchor" href="#_create_a_machine_autoscaler"></a>Create a Machine Autoscaler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we can configure cluster autoscaling, we first need to configure machine autoscaler to scale each of our MachineSets.</p>
</div>
<div class="paragraph">
<p>While this can be accomplished via the OpenShift Web Console or OpenShift CLI tools, we&#8217;ll be using the CLI for this part of the workshop.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Just like the last section, let&#8217;s pick a MachineSet to add a machine autoscaler.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">MACHINESET=$(oc -n openshift-machine-api get machinesets -o name \
   | cut -d / -f2 | head -1)

echo ${MACHINESET}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">aro-cluster-lwqq8-8mkmr-worker-eastus1</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s use that information to populate a manifest to create a machine autoscaler.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt;EOF | oc apply -f -
---
apiVersion: "autoscaling.openshift.io/v1beta1"
kind: "MachineAutoscaler"
metadata:
  name: "${MACHINESET}"
  namespace: "openshift-machine-api"
spec:
  minReplicas: 1
  maxReplicas: 3
  scaleTargetRef:
    apiVersion: machine.openshift.io/v1beta1
    kind: MachineSet
    name: "${MACHINESET}"
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">machineautoscaler.autoscaling.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1 created</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s check to see that our machine autoscaler has been created.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-machine-api get machineautoscaler</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">NAME                                     REF KIND     REF NAME                                 MIN   MAX   AGE
aro-cluster-lwqq8-8mkmr-worker-eastus1   MachineSet   aro-cluster-lwqq8-8mkmr-worker-eastus1   1     3     16s</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_cluster_autoscaler"><a class="anchor" href="#_create_a_cluster_autoscaler"></a>Create a Cluster Autoscaler</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Next, we need to create the cluster autoscaler resource.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt;EOF | oc apply -f -
---
apiVersion: "autoscaling.openshift.io/v1"
kind: "ClusterAutoscaler"
metadata:
  name: default
spec:
  podPriorityThreshold: -10
  resourceLimits:
    maxNodesTotal: 10
    cores:
      min: 8
      max: 128
    memory:
      min: 4
      max: 256
  scaleDown:
    enabled: true
    delayAfterAdd: 2m
    delayAfterDelete: 1m
    delayAfterFailure: 15s
    unneededTime: 1m
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">clusterautoscaler.autoscaling.openshift.io/default created</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s check to see that our cluster autoscaler has been created.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get clusterautoscaler</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">NAME      AGE
default   22s</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a detailed explanation of each parameter, see the <a href="https://docs.openshift.com/container-platform/latest/machine_management/applying-autoscaling.html#cluster-autoscaler-cr_applying-autoscaling">Red Hat documentation on the cluster autoscaler</a>.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_the_cluster_autoscaler"><a class="anchor" href="#_test_the_cluster_autoscaler"></a>Test the Cluster Autoscaler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now let&#8217;s test the cluster autoscaler and see it in action.
To do so, we&#8217;ll deploy a job with a load that this cluster cannot handle.
This should force the cluster to scale to handle the load.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, let&#8217;s create a namespace (also known as a project in OpenShift).
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-project autoscale-ex</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Now using project "autoscale-ex" on server "https://api.rbrlitrg.westeurope.aroapp.io:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/e2e-test-images/agnhost:2.33 -- /agnhost serve-hostname</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s deploy our job that will exhaust the cluster&#8217;s resources and cause it to scale more worker nodes.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt; EOF | oc create -f -
---
apiVersion: batch/v1
kind: Job
metadata:
  generateName: maxscale
  namespace: autoscale-ex
spec:
  template:
    spec:
      containers:
      - name: work
        image: busybox
        command: ["sleep",  "300"]
        resources:
          requests:
            memory: 500Mi
            cpu: 500m
      restartPolicy: Never
  backoffLimit: 4
  completions: 50
  parallelism: 50
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">job.batch/maxscale7s6c6 created</code></pre>
</div>
</div>
</li>
<li>
<p>After a few seconds, run the following to see what pods have been created.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n autoscale-ex get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">NAME                  READY   STATUS    RESTARTS   AGE
maxscale7s6c6-2z67x   1/1     Running   0          31s
maxscale7s6c6-45th7   1/1     Running   0          31s
maxscale7s6c6-4kd92   0/1     Pending   0          31s
maxscale7s6c6-4vcqq   1/1     Running   0          31s
maxscale7s6c6-6jhc6   0/1     Pending   0          31s
maxscale7s6c6-6zl86   0/1     Pending   0          31s
maxscale7s6c6-96vdc   0/1     Pending   0          31s
maxscale7s6c6-9k68x   1/1     Running   0          31s
maxscale7s6c6-9nkkp   0/1     Pending   0          31s

[... Output Omitted ...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we see a lot of pods in a pending state.
This should trigger the cluster autoscaler to create more machines using the MachineAutoscaler we created.</p>
</div>
</li>
<li>
<p>Let&#8217;s check to see if our MachineSet automatically scaled.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-machine-api get machinesets</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">NAME                                     DESIRED   CURRENT   READY   AVAILABLE   AGE
aro-cluster-lwqq8-8mkmr-worker-eastus1   3         3         1       1           111m
aro-cluster-lwqq8-8mkmr-worker-eastus2   1         1         1       1           111m
aro-cluster-lwqq8-8mkmr-worker-eastus3   1         1         1       1           111m</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>If you see READY and AVAILABLE at 1 still, don&#8217;t panic! It can take a few minutes for the workers to instantiate. Try checking again after 3-5 minutes.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>This shows that the cluster autoscaler is working on scaling the MachineSet up to 3.</p>
</div>
</li>
<li>
<p>Now let&#8217;s watch the cluster autoscaler create and delete machines as necessary.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">watch oc -n openshift-machine-api get machines \
   -l "machine.openshift.io/cluster-api-machine-role=worker"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Every 2.0s: oc -n openshift-machine-api get machines -l machine.openshift...  bastion-lwqq8: Tue Dec 19 09:04:00 2023

NAME                                           PHASE         TYPE              REGION   ZONE   AGE
aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v   Provisioned   Standard_D4s_v3   eastus   1      53s
aro-cluster-lwqq8-8mkmr-worker-eastus1-8vzrw   Provisioned   Standard_D4s_v3   eastus   1      3m46s
aro-cluster-lwqq8-8mkmr-worker-eastus1-vgmng   Running       Standard_D4s_v3   eastus   1      107m
aro-cluster-lwqq8-8mkmr-worker-eastus2-m4dgh   Running       Standard_D4s_v3   eastus   2      107m
aro-cluster-lwqq8-8mkmr-worker-eastus3-k65k6   Running       Standard_D4s_v3   eastus   3      107m</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Watch will refresh the output of a command every two seconds. Hit CTRL and c on your keyboard to exit the watch command when you&#8217;re ready to move on to the next part of the workshop.</p>
</div>
</div>
</div>
</li>
<li>
<p>When all the pods have run to completion the cluster autoscaler will scale the MachineSet back to just one worker node. This will take a while so we are not waiting for that to happen.</p>
<div class="paragraph">
<p>You can continue with the next lab while the cluster does its work.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Congratulations!</strong></p>
</div>
<div class="paragraph">
<p>You&#8217;ve successfully demonstrated cluster autoscaling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here you learned how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and configure a machine autoscaler</p>
</li>
<li>
<p>Deploy an application on the cluster and watch the cluster autoscaler scale your cluster to support the increased workload</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="lab_2_managing_worker_nodes.html" class="query-params-link">Managing Worker Nodes</a></span>
  <span class="next"><a href="lab_4_labeling_nodes.html" class="query-params-link">Labeling your Worker Nodes</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
