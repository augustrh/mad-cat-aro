<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Modern App Dev Roadshow - Cloud Architect Track for ARO</title>
    <link rel="prev" href="lab_3_autoscaling.html">
    <link rel="next" href="lab_5_observability.html">
    <meta name="generator" content="Antora 3.1.5">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="../..">Modern App Dev Roadshow - Cloud Architect Track for ARO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_1_environment.html">Explore the environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_2_access_cluster.html">Access your ARO cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_1_cluster_upgrades.html">Upgrade your ARO cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_2_managing_worker_nodes.html">Managing Worker Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_3_autoscaling.html">Autoscale your ARO Cluster</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="lab_4_labeling_nodes.html">Labeling your Worker Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_5_observability.html">Configure Red Hat OpenShift Logging with Azure Files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_1_deploy_app.html">Deploy an application with Azure Database</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_2_openshift_gitops.html">Deploy an application with Red Hat OpenShift GitOps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_3_network_policy.html">Secure your applications with Network Policies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_4_resilient_app.html">Make your application resilient</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_1_service_mesh_introduction.html">Service Mesh Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_2_service_mesh_deploy_operator.html">Install Service Mesh Operator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_3_service_mesh_deploy_control_plane.html">Deploy Service Mesh Control Plane</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_4_service_mesh_deploy_app.html">Deploy a Service Mesh example application</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_5_service_mesh_weighted_routing.html">Set up Service Mesh Weighted Routing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_6_service_mesh_observe.html">Configure and observe Service Mesh traffic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../conclusion.html">Conclusion &amp; What&#8217;s Next</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></li>
    <li><a href="lab_4_labeling_nodes.html">Labeling your Worker Nodes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/content/modules/ROOT/pages/200-ops/lab_4_labeling_nodes.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Labels are a useful way to select which nodes that an application will run on.
These nodes are created by machines which are defined by the MachineSets we worked with in previous sections of this workshop.
An example of this would be running a memory intensive application only on a specific node type.</p>
</div>
<div class="paragraph">
<p>While you can directly add a label to a node, it is not recommended because nodes can be recreated, which would cause the label to disappear.
Therefore we need to label the MachineSet itself.
An important caveat to this process is that only <strong>new machines</strong> created by the MachineSet will get the label.
This means you will need to either scale the MachineSet down to zero then back up to create new machines with the label, or you can label the existing machines directly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_a_label_for_the_machineset"><a class="anchor" href="#_set_a_label_for_the_machineset"></a>Set a label for the MachineSet</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Just like the last section, let&#8217;s pick a MachineSet to add our label.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">MACHINESET=$(oc -n openshift-machine-api get machinesets -o name | head -1)

echo ${MACHINESET}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">machineset.machine.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1</code></pre>
</div>
</div>
</li>
<li>
<p>Now, let&#8217;s patch the MachineSet with our new label.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-machine-api patch ${MACHINESET} \
  --type=merge \
  --patch '{"spec":{"template":{"spec":{"metadata":{"labels":{"tier":"frontend"}}}}}}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">machineset.machine.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1 patched</code></pre>
</div>
</div>
</li>
<li>
<p>As you&#8217;ll remember, the existing machines won&#8217;t get this label, but all new machines will.
While we could just scale this MachineSet down to zero and back up again, that could disrupt our workloads.
Instead, let&#8217;s just loop through and add the label to all of our nodes in that MachineSet.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">MACHINES=$(oc -n openshift-machine-api get machines -o name -l "machine.openshift.io/cluster-api-machineset=$(echo $MACHINESET | cut -d / -f2 )" | cut -d / -f2 | xargs)

for MACHINE in $(echo ${MACHINES}); do
  oc label -n openshift-machine-api machine ${MACHINE} tier=frontend
  oc label node ${MACHINE} tier=frontend
done</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">machine.machine.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v labeled
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v labeled
machine.machine.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1-8vzrw labeled
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-8vzrw labeled
machine.machine.openshift.io/aro-cluster-lwqq8-8mkmr-worker-eastus1-vgmng labeled
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-vgmng labeled</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Depending when (or if) you did the Autoscaling lab you may have 1, 2 or 3 Machines and Nodes that get the label.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Now, let&#8217;s verify the nodes are properly labeled.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get nodes --selector='tier=frontend' -o name</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">node/aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-8vzrw
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-vgmng</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pending that your output shows one or more node(s), this demonstrates that our MachineSet and associated nodes are properly annotated!</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_an_app_to_the_labeled_nodes"><a class="anchor" href="#_deploy_an_app_to_the_labeled_nodes"></a>Deploy an app to the labeled nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we&#8217;ve successfully labeled our nodes, let&#8217;s deploy a workload to demonstrate app placement using <code>nodeSelector</code>.
This should force our app to deploy only on labeled nodes.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, let&#8217;s create a namespace (also known as a project in OpenShift).
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-project nodeselector-ex</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Now using project "nodeselector-ex" on server "https://api.rbrlitrg.westeurope.aroapp.io:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/e2e-test-images/agnhost:2.33 -- /agnhost serve-hostname</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s deploy our application and associated resources that will target our labeled nodes.
Notice how we added the <code>nodeSelector</code> to the specification of our Deployment to do this.
Run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt; EOF | oc create -f -
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: nodeselector-app
  namespace: nodeselector-ex
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nodeselector-app
  template:
    metadata:
      labels:
        app: nodeselector-app
    spec:
      nodeSelector:
        tier: frontend
      containers:
        - name: hello-openshift
          image: "docker.io/openshift/hello-openshift"
          ports:
            - containerPort: 8080
              protocol: TCP
            - containerPort: 8888
              protocol: TCP
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">deployment.apps/nodeselector-app created</code></pre>
</div>
</div>
</li>
<li>
<p>Now, let&#8217;s validate that the application has been deployed to one of the labeled nodes.
To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n nodeselector-ex get pod -l app=nodeselector-app \
   -o jsonpath='{.items[0].spec.nodeName}'; echo</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v</code></pre>
</div>
</div>
</li>
<li>
<p>Double check the name of the node to compare it to the output above to ensure the node selector worked to put the pod on the correct node:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get nodes --selector='tier=frontend' -o name</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">node/aro-cluster-lwqq8-8mkmr-worker-eastus1-6qt5v
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-8vzrw
node/aro-cluster-lwqq8-8mkmr-worker-eastus1-vgmng</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the list of nodes look for the final string to match, in this example <code>shj9g</code>)</p>
</div>
</li>
<li>
<p>Next create a <code>service</code> using the <code>oc expose</code> command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc expose deployment nodeselector-app -n nodeselector-ex</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">service/nodeselector-app exposed</code></pre>
</div>
</div>
</li>
<li>
<p>Expose the newly created <code>service</code> with a <code>route</code>:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc create route edge --service=nodeselector-app --insecure-policy=Redirect -n nodeselector-ex</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">route.route.openshift.io/nodeselector-app created</code></pre>
</div>
</div>
</li>
<li>
<p>Fetch the URL for the newly created <code>route</code>:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get routes/nodeselector-app -n nodeselector-ex -o jsonpath='https://{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">https://nodeselector-app-nodeselector-ex.apps.nbybk9f3.eastus.aroapp.io</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then visit the URL presented in a new tab in your web browser (using HTTPS).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The application is exposed over the default ingress using a predetermined URL and trusted TLS certificate. This is done using the OpenShift <code>Route</code> resource which is an extension to the Kubernetes <code>Ingress</code> resource.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Congratulations!</strong></p>
</div>
<div class="paragraph">
<p>You&#8217;ve successfully demonstrated the ability to label nodes and target those nodes using a <code>nodeSelector</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here you learned how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set labels on new nodes in a MachineSet</p>
</li>
<li>
<p>Set labels on existing nodes in a MachineSet</p>
</li>
<li>
<p>Deploy an application on nodes with a certain label</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="lab_3_autoscaling.html" class="query-params-link">Autoscale your ARO Cluster</a></span>
  <span class="next"><a href="lab_5_observability.html" class="query-params-link">Configure Red Hat OpenShift Logging with Azure Files</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
