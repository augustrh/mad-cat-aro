<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Modern App Dev Roadshow - Cloud Architect Track for ARO</title>
    <link rel="prev" href="lab_4_labeling_nodes.html">
    <link rel="next" href="../300-apps/lab_1_deploy_app.html">
    <meta name="generator" content="Antora 3.1.5">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="../..">Modern App Dev Roadshow - Cloud Architect Track for ARO</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="modules" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html" class=" query-params-link">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_1_environment.html">Explore the environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../100-setup/lab_2_access_cluster.html">Access your ARO cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_1_cluster_upgrades.html">Upgrade your ARO cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_2_managing_worker_nodes.html">Managing Worker Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_3_autoscaling.html">Autoscale your ARO Cluster</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="lab_4_labeling_nodes.html">Labeling your Worker Nodes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="lab_5_observability.html">Configure Red Hat OpenShift Logging with Azure Files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_1_deploy_app.html">Deploy an application with Azure Database</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_2_openshift_gitops.html">Deploy an application with Red Hat OpenShift GitOps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_3_network_policy.html">Secure your applications with Network Policies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../300-apps/lab_4_resilient_app.html">Make your application resilient</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_1_service_mesh_introduction.html">Service Mesh Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_2_service_mesh_deploy_operator.html">Install Service Mesh Operator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_3_service_mesh_deploy_control_plane.html">Deploy Service Mesh Control Plane</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_4_service_mesh_deploy_app.html">Deploy a Service Mesh example application</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_5_service_mesh_weighted_routing.html">Set up Service Mesh Weighted Routing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../400-service-mesh/lab_6_service_mesh_observe.html">Configure and observe Service Mesh traffic</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../conclusion.html">Conclusion &amp; What&#8217;s Next</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Modern App Dev Roadshow - Cloud Architect Track for ARO</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Modern App Dev Roadshow - Cloud Architect Track for ARO</a></li>
    <li><a href="lab_5_observability.html">Configure Red Hat OpenShift Logging with Azure Files</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///antora/content/modules/ROOT/pages/200-ops/lab_5_observability.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Azure Red Hat OpenShift (ARO) clusters store log data inside the cluster by default. Understanding metrics and logs is critical in successfully running your cluster. Included with ARO is the OpenShift Cluster Logging Operator, which is intended to simplify log management and analysis within an ARO cluster, offering centralized log collection, powerful search capabilities, visualization tools, and integration with other other Azure systems like <a href="https://azure.microsoft.com/en-us/products/storage/files" target="_blank" rel="noopener">Azure Files</a>.</p>
</div>
<div class="paragraph">
<p>In this section of the workshop, we&#8217;ll configure ARO to forward logs and metrics to Azure Files and view them using Grafana.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_metrics_and_log_forwarding_to_azure_files"><a class="anchor" href="#_configure_metrics_and_log_forwarding_to_azure_files"></a>Configure Metrics and Log Forwarding to Azure Files</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, let&#8217;s create our Azure Files storage account. To do so, run the following command::</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">AZR_STORAGE_ACCOUNT_NAME="storage${GUID}"

ARO_LOCATION=$(az aro show --resource-group openenv-${GUID} --name aro-cluster-${GUID} --query location -o tsv)

az storage account create --name "${AZR_STORAGE_ACCOUNT_NAME}" --allow-blob-public-access --resource-group "openenv-${GUID}" --location "${AZ_LOCATION}" --sku Standard_LRS</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">The public access to all blobs or containers in the storage account will be disallowed by default in the future, which means default value for --allow-blob-public-access is still null but will be equivalent to false.
{
 "accessTier": "Hot",
  "accountMigrationInProgress": null,
  "allowBlobPublicAccess": true,
  "allowCrossTenantReplication": false,

[... Lots of output Omitted ...]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may get an error about rate limiting when running the <code>az storage account create</code> command. If so just wait a few seconds and repeat the command.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Next, let&#8217;s grab our storage account key. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">AZR_STORAGE_KEY=$(az storage account keys list --resource-group "openenv-${GUID}" -n "${AZR_STORAGE_ACCOUNT_NAME}" --query "[0].value" -o tsv)

echo ${AZR_STORAGE_KEY}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">gr6ujd144KyO14BVQ5cEupJw/MWQx/XvXxQE/eG62oOvoVfnLVO68EcFGDygSXQD4pUGx+oA+wNJ+AStwccBSw==</code></pre>
</div>
</div>
</li>
<li>
<p>Now, let&#8217;s create a separate storage bucket for logs and metrics. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">az storage container create --name "aro-logs" \
  --account-name "${AZR_STORAGE_ACCOUNT_NAME}" \
  --account-key "${AZR_STORAGE_KEY}"
az storage container create --name "aro-metrics" \
  --account-name "${AZR_STORAGE_ACCOUNT_NAME}" \
  --account-key "${AZR_STORAGE_KEY}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">{
  "created": true
}
{
  "created": true
}</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy ElasticSearch CRDs (not used, but needed for a <a href="https://access.redhat.com/solutions/6990588">bug workaround</a>):</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc create -f https://raw.githubusercontent.com/openshift/elasticsearch-operator/release-5.8/bundle/manifests/logging.openshift.io_elasticsearches.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">customresourcedefinition.apiextensions.k8s.io/elasticsearches.logging.openshift.io created</code></pre>
</div>
</div>
</li>
<li>
<p>Check that <code>helm</code> is installed properly:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm version</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">version.BuildInfo{Version:"v3.12.1+11.el8", GitCommit:"8cc4ba6fcc61d4c2ad2084c214dda40124bf5d32", GitTreeState:"clean", GoVersion:"go1.19.10"}</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s add the MOBB Helm Chart repository. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm repo add mobb https://rh-mobb.github.io/helm-charts/

helm repo update</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">"mobb" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "mobb" chart repository
Update Complete. ⎈Happy Helming!⎈</code></pre>
</div>
</div>
</li>
<li>
<p>Now, we need to create a project (namespace) to deploy our logging resources to. To create that, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-project custom-logging</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Now using project "custom-logging" on server "https://api.rbrlitrg.westeurope.aroapp.io:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/e2e-test-images/agnhost:2.33 -- /agnhost serve-hostname</code></pre>
</div>
</div>
</li>
<li>
<p>Next, we need to install a few operators to run our logging setup. These operators include the Red Hat Cluster Logging Operator, the Loki operator, the Grafana operator, and more. First, we&#8217;ll create a list of all the operators we&#8217;ll need to install by running the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt;EOF &gt; clf-operators.yaml
subscriptions:
- name: grafana-operator
  channel: v4
  installPlanApproval: Automatic
  source: community-operators
  sourceNamespace: openshift-marketplace
- name: cluster-logging
  channel: stable
  installPlanApproval: Automatic
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  namespace: openshift-logging
- name: loki-operator
  channel: stable
  installPlanApproval: Automatic
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  namespace: openshift-operators-redhat
- name: resource-locker-operator
  channel: alpha
  installPlanApproval: Automatic
  source: community-operators
  sourceNamespace: openshift-marketplace
  namespace: resource-locker-operator
- name: patch-operator
  channel: alpha
  installPlanApproval: Automatic
  source: community-operators
  sourceNamespace: openshift-marketplace
  namespace: patch-operator
operatorGroups:
- name: custom-logging
  targetNamespace: ~
- name: openshift-logging
  namespace: openshift-logging
  targetNamespace: openshift-logging
- name: openshift-operators-redhat
  namespace: openshift-operators-redhat
  targetNamespace: all
- name: resource-locker
  namespace: resource-locker-operator
  targetNamespace: all
- name: patch-operator
  namespace: patch-operator
  targetNamespace: all
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s deploy the Grafana, Cluster Logging, and Loki operators from the file we just created above. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc create ns openshift-logging

oc create ns openshift-operators-redhat

oc create ns resource-locker-operator

oc create ns patch-operator

helm upgrade -n custom-logging clf-operators \
  mobb/operatorhub --install \
  --values ./clf-operators.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">namespace/openshift-logging created
namespace/openshift-operators-redhat created
namespace/resource-locker-operator created
Release "clf-operators" does not exist. Installing it now.
NAME: clf-operators
LAST DEPLOYED: Tue Dec 19 09:40:44 2023
NAMESPACE: custom-logging
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
.</code></pre>
</div>
</div>
</li>
<li>
<p>Now, let&#8217;s wait for the operators to be installed.</p>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>These commands will loop through each type of resource until the CRDs for the Operators have been deployed.</p>
</div>
<div class="paragraph">
<p>Eventually you&#8217;ll see the message <code>No resources found in custom-logging namespace</code> and be returned to a prompt.</p>
</div>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">while ! oc get grafana; do sleep 5; echo -n .; done
while ! oc get clusterlogging; do sleep 5; echo -n .; done
while ! oc get lokistack; do sleep 5; echo -n .; done
while ! oc get resourcelocker; do sleep 5; echo -n .; done</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">No resources found in custom-logging namespace.
No resources found in custom-logging namespace.
No resources found in custom-logging namespace.
No resources found in custom-logging namespace.</code></pre>
</div>
</div>
</li>
<li>
<p>Now that the operators have been successfully installed, let&#8217;s use a helm chart to deploy Grafana and forward metrics to Azure Files. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm upgrade -n "custom-logging" aro-thanos-af \
  --install mobb/aro-thanos-af --version 0.6.3 \
  --set "aro.storageAccount=${AZR_STORAGE_ACCOUNT_NAME}" \
  --set "aro.storageAccountKey=${AZR_STORAGE_KEY}" \
  --set "aro.storageContainer=aro-metrics" \
  --set "enableUserWorkloadMetrics=true"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Release "aro-thanos-af" does not exist. Installing it now.
NAME: aro-thanos-af
LAST DEPLOYED: Tue Dec 19 09:41:57 2023
NAMESPACE: custom-logging
STATUS: deployed
REVISION: 1
TEST SUITE: None</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you get an error during that command wait a few seconds and try it again. Sometimes the Patch Operator takes a little longer to fully deploy.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Wait until Grafana has successfully deployed. Run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n custom-logging rollout status deploy grafana-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s ensure that we can access Grafana. To do so, we should fetch its route and try browsing to it with your web browser. To grab the route, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n custom-logging get route grafana-route \
  -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">https://grafana-route-custom-logging.apps.nbybk9f3.eastus.aroapp.io</code></pre>
</div>
</div>
</li>
<li>
<p>You should already be logged into the cluster because you logged into the web console earlier. Accept all permissions by clicking on <strong>Allow selected permissions</strong>. You should see the Grafana dashboard.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If your browser displays an error that says <em>'Application is not available'</em> wait a minute and try again.</p>
</div>
<div class="paragraph">
<p>If it persists you&#8217;ve hit a race condition with certificate creation.</p>
</div>
<div class="paragraph">
<p>Run the following command to try to resolve it:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc patch -n custom-logging service grafana-alert -p '{ "metadata": { "annotations": null }}'

oc -n custom-logging delete secret aro-thanos-af-grafana-cr-tls

oc patch -n custom-logging service grafana-service \
    -p '{"metadata":{"annotations":{"retry": "true" }}}'

sleep 5

oc -n custom-logging rollout restart deployment grafana-deployment</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_log_forwarding"><a class="anchor" href="#_set_up_log_forwarding"></a>Set up Log Forwarding</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Now, set the storage class to use for the persistent volumes to be created - using the storage class that is set as the default storage class:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">STORAGE_CLASS=$(oc get storageclass -o=jsonpath='{.items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")].metadata.name}')

echo ${STORAGE_CLASS}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">managed-csi</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s use another helm chart to deploy forward logs to Azure Files. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">helm upgrade -n custom-logging aro-clf-blob \
 --install mobb/aro-clf-blob --version 0.1.3 \
 --set "azure.storageAccount=${AZR_STORAGE_ACCOUNT_NAME}"  \
 --set "azure.storageAccountKey=${AZR_STORAGE_KEY}"   \
 --set "azure.storageContainer=aro-logs" \
 --set "lokiStack.storageClassName=${STORAGE_CLASS}"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">Release "aro-clf-blob" does not exist. Installing it now.
NAME: aro-clf-blob
LAST DEPLOYED: Tue Dec 19 09:43:20 2023
NAMESPACE: custom-logging
STATUS: deployed
REVISION: 1
TEST SUITE: None</code></pre>
</div>
</div>
</li>
<li>
<p>Once the Helm Chart deploys its resource, we need to wait for the Log Collector agent to be started. To watch its status, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-logging rollout status daemonset collector</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">daemon set "collector" successfully rolled out</code></pre>
</div>
</div>
</li>
<li>
<p>Occasionally, the log collector agent starts before the operator has finished configuring Loki. To proactively address this, we need to restart the agent. To do so, run the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-logging rollout restart daemonset collector</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">daemonset.apps/collector restarted</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_view_the_metrics_and_logs"><a class="anchor" href="#_view_the_metrics_and_logs"></a>View the Metrics and Logs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the metrics and log forwarding are forwarding to Azure Files, let&#8217;s view them in Grafana.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First, we&#8217;ll need to fetch the route for Grafana and visit it in our web browser. To get the route, run the following command</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n custom-logging get route grafana-route \
   -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">https://grafana-route-custom-logging.apps.nbybk9f3.eastus.aroapp.io</code></pre>
</div>
</div>
</li>
<li>
<p>Browse to the provided route address in the same browser window as your OCP console and login using your OpenShift credentials. If you tested this before you are already logged in.</p>
</li>
<li>
<p>View an existing dashboard such as <strong>custom-logging -&gt; Node Exporter -&gt; USE Method -&gt; Cluster</strong> (click on the <strong>search</strong> icon on the left to see the <strong>custom-logging</strong> dashboard).</p>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>These dashboards are copies of the dashboards that are available directly on the OpenShift web console under <strong>Observability</strong>".</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/grafana-metrics.png" alt="grafana metrics">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you don&#8217;t see the graphs as in the screenshot above wait a minute and refresh the browser window - it takes a few minutes for the Grafana dashboard to start showing data.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Click the Explore (compass) Icon in the left hand menu, select &#8220;Loki (Application)&#8221; in the dropdown and search for <code>{kubernetes_namespace_name="custom-logging"}</code>. Click the blue <strong>Run Query</strong> button on the top right to execute the search.</p>
<div class="imageblock">
<div class="content">
<img src="../_images/grafana-logs.png" alt="grafana logs">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enabling_custom_metrics"><a class="anchor" href="#_enabling_custom_metrics"></a>Enabling Custom Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to display metrics from your own applications you need to enable custom metrics.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check the cluster-monitoring-config ConfigMap object:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-monitoring get configmap cluster-monitoring-config -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">apiVersion: v1
data: {}
kind: ConfigMap
metadata:
  creationTimestamp: "2023-06-06T17:11:22Z"
  name: cluster-monitoring-config
  namespace: openshift-monitoring
  resourceVersion: "391968"
  uid: 5d84fef5-d798-4b11-bb2f-dd93fc6e76d8</code></pre>
</div>
</div>
</li>
<li>
<p>Enable User Workload Monitoring:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc patch configmap cluster-monitoring-config -n openshift-monitoring \
  --patch='{"data":{"config.yaml": "enableUserWorkload: true\n"}}'</code></pre>
</div>
</div>
</li>
<li>
<p>Check that the User workload monitoring is starting up (wait until the output below matches what you see):</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-user-workload-monitoring get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">NAME                                   READY   STATUS    RESTARTS   AGE
prometheus-operator-78774d88c8-vq2pz   2/2     Running   0          23m
prometheus-user-workload-0             6/6     Running   0          23m
prometheus-user-workload-1             6/6     Running   0          23m
thanos-ruler-user-workload-0           3/3     Running   0          23m
thanos-ruler-user-workload-1           3/3     Running   0          23m</code></pre>
</div>
</div>
</li>
<li>
<p>Append <code>remoteWrite</code> settings to the user-workload-monitoring config to forward user workload metrics to Thanos.</p>
<div class="paragraph">
<p>Check if the User Workload Config Map exists:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc -n openshift-user-workload-monitoring get \
  configmaps user-workload-monitoring-config -o yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample Output</div>
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-text hljs" data-lang="text">apiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: "2023-06-07T09:14:09Z"
  name: user-workload-monitoring-config
  namespace: openshift-user-workload-monitoring
  resourceVersion: "392232"
  uid: c1a3c96a-1773-4a56-ba4d-537c7cb9a92a</code></pre>
</div>
</div>
</li>
<li>
<p>Update the ConfigMap:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cat &lt;&lt; EOF | kubectl apply -f -
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: user-workload-monitoring-config
  namespace: openshift-user-workload-monitoring
data:
  config.yaml: |
    prometheus:
      remoteWrite:
      - url: "http://thanos-receive.custom-logging.svc.cluster.local:9091/api/v1/receive"
EOF</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Congratulations!</strong></p>
</div>
<div class="paragraph">
<p>Your cluster is now configured to allow custom metrics.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here you learned how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure metrics and log forwarding to Azure Files</p>
</li>
<li>
<p>View the metrics and logs in a Grafana dashboard</p>
</li>
</ul>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="lab_4_labeling_nodes.html" class="query-params-link">Labeling your Worker Nodes</a></span>
  <span class="next"><a href="../300-apps/lab_1_deploy_app.html" class="query-params-link">Deploy an application with Azure Database</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
